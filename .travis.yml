# Travis CI configuration file.

language: php

# Configure caches
cache:
  apt: true

# 5.6 is required for Codeception.
php:
    - 5.6
    - 7.0

# Run against regular and multisite.
env:
    - WP_MULTISITE=0
    - WP_MULTISITE=1

# Use the new container-based infrastructure (it's faster).
sudo: false

matrix:
    include:
        - php: hhvm
          env: WP_MULTISITE=0
          sudo: required
          dist: trusty
          group: edge
          addons:
            apt:
              packages:
              - mysql-server-5.6
              - mysql-client-core-5.6
              - mysql-client-5.6
        - php: nightly
          env: WP_MULTISITE=0
    allow_failures:
        - php: hhvm
        - php: nightly
    fast_finish: true

# Disable x-debug to speed up things
before_install: phpenv config-rm xdebug.ini

# Install packages those will be required during build
install:
  - composer install --no-interaction

# Prepare test environment
before_script:
  # Define vars.
  - export WP_VERSION=master
  - export WP_DEVELOP_DIR=/tmp/wordpress
  - export WP_CORE_DIR=/tmp/wordpress/src
  - export WP_CEPT_SERVER='127.0.0.1:8888'
  - mkdir -p "$WP_DEVELOP_DIR"
  - git clone --depth=1 --branch="$WP_VERSION" git://develop.git.wordpress.org/ "$WP_DEVELOP_DIR"
  - cd "$WP_DEVELOP_DIR"

  # Create wp-config.php
  - cp wp-tests-config-sample.php wp-config.php
  - sed -i "s/youremptytestdbnamehere/wordpress_test/" wp-config.php
  - sed -i "s/yourusernamehere/root/" wp-config.php
  - sed -i "s/yourpasswordhere//" wp-config.php
  - sed -i "s/'example.org'/'$WP_CEPT_SERVER'/" wp-config.php
  - echo "define( 'MULTISITE', true );" >> wp-config.php
  - echo "define( 'SUBDOMAIN_INSTALL', false );" >> wp-config.php
  - echo "\$GLOBALS['base'] = '/';" >> wp-config.php
  - echo "require_once(ABSPATH . 'wp-settings.php');" >> wp-config.php

  # Create database
  - mysql -e 'CREATE DATABASE wordpress_test;' -uroot

  # Populate database with test-suite
  - php tests/phpunit/includes/install.php wp-config.php "1"

  # Move back to our directory
  - cd -

  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start
  - echo "Download selenium-server-standalone jar file"
  - wget -c -nc --retry-connrefused --tries=0 http://selenium-release.storage.googleapis.com/2.53/selenium-server-standalone-2.53.1.jar -O selenium-server-standalone.jar
  - echo "Run selenium server - background process"
  - nohup bash -c "java -jar selenium-server-standalone.jar &" && sleep 1; cat nohup.out
  - echo "Run php in-built server - background process"
  - nohup bash -c "$WP_CEPT_SERVER" -t "$WP_CORE_DIR" && sleep 1; cat nohup.out

# Run main commands
script:
  - vendor/bin/codecept run

#after_script:

#after_success:

#after_failure:


# Tell Travis CI to monitor only 'master' branch
branches:
  only: master

# Cache folder, you can delete cache from Travis CI web interface
cache:
    directories:
        - vendor
        - $HOME/.composer/cache
